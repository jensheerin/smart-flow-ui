# ----------------------------------------------------------------------------------------------------
# Pipeline for AZD process
# ----------------------------------------------------------------------------------------------------
name: smartflow-ui

metadata:
  template: azd-init@1.11.0

infra:
  provider: bicep
  path: infra/bicep
  module: main

services:
  api:
    project: ./app/SmartFlow.UI.API
    host: containerapp
    language: dotnet
    docker:
      path: ./app/Dockerfile
      context: ./app

hooks:
  # This script gets my IP address
  preprovision:
    shell: pwsh
    run: |
      $myIP = $(Invoke-WebRequest -Uri "https://api.ipify.org").Content
      azd env set MY_IP $myIP
    continueOnError: false
    interactive: false
  postprovision:
    shell: pwsh
    run: |
      Write-Host "Loading azd .env file from current environment"

      # Use the `get-values` azd command to retrieve environment variables from the `.env` file
      $envValues = azd env get-values

      $envDict = @{}

      foreach ($line in $envValues -split "`n") {
          if ($line -match '^(.*?)=(.*)$') {
              $key = $Matches[1]
              $value = $Matches[2].Trim('"') # Remove surrounding quotes
              $envDict[$key] = $value
          }
      }

      $json_content = @{
        AOAIPremiumServiceEndpoint = $envDict['AI_ENDPOINT']
        AOAIPremiumChatGptDeployment = "gpt-4o"
        AOAIStandardServiceEndpoint = $envDict['AI_ENDPOINT']
        AOAIStandardChatGptDeployment = "gpt-4o"
        AOAIEmbeddingsDeployment = "text-embedding"
        AzureSearchServiceEndpoint = $envDict['AI_SEARCH_ENDPOINT']
        CosmosDbEndpoint = $envDict['COSMOS_ENDPOINT']
        CosmosDbDatabaseName = "ChatHistory"
        CosmosDbCollectionName = "ChatTurn"
        AzureStorageAccountEndpoint = $envDict['STORAGE_ACCOUNT_ENDPOINT']
        AzureStorageUserUploadContainer = "content"
        UseManagedIdentityResourceAccess = $true
        ProfileFileName = "profiles"
        ShowCollectionsSelection = "True"
        ShowFileUploadSelection = "True"
      } | ConvertTo-Json -Depth 5

      $json_content | Set-Content ./app/SmartFlow.UI.API/appsettings.Development.json
    continueOnError: false
    interactive: false
